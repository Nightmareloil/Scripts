-- 2take1 Hub--
local Players = game:GetService("Players")
local player = Players.LocalPlayer

if not game:IsLoaded() then
    game.Loaded:Wait()
end

local UIS = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")

local Config = {
    speed = 5,
    range = 15,
    walkSpeed = 16,
    jumpPower = 50,
    flySpeed = 50,
    commandPrefix = ";"
}

local State = {
    fastFarm = false,
    slowFarm = false,
    godMode = false,
    killAura = false,
    flying = false,
    noclip = false,
    commandBarVisible = false,
    loopKill = false,
    loopKillTargets = {},
    killAllActive = false
}

local Stats = {
    power = 0,
    kills = 0,
    health = 100,
    powerGainedThisSession = 0,
    sessionStartTime = tick(),
    lastPowerCheck = 0,
    powerPerSecond = 0,
    powerPerHour = 0,
    lastUpdateTime = tick()
}

local Data = {
    adminPlayers = {},
    connections = {},
    flyObjects = {},
    killAllTargets = {}
}

local Theme = {
    background = Color3.fromRGB(25, 25, 25),
    secondary = Color3.fromRGB(35, 35, 35),
    tertiary = Color3.fromRGB(45, 45, 45),
    accent = Color3.fromRGB(88, 101, 242),
    text = Color3.fromRGB(255, 255, 255),
    success = Color3.fromRGB(87, 242, 135),
    danger = Color3.fromRGB(237, 66, 69),
    warning = Color3.fromRGB(255, 193, 7)
}

-- GUI Setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "2take1Hub"
screenGui.ResetOnSpawn = false
pcall(function() screenGui.Parent = game:GetService("CoreGui") end)
if not screenGui.Parent then screenGui.Parent = player:WaitForChild("PlayerGui") end

-- Command Bar
local commandBarFrame = Instance.new("Frame")
commandBarFrame.Name = "CommandBar"
commandBarFrame.Size = UDim2.new(0, 400, 0, 40)
commandBarFrame.Position = UDim2.new(0.5, -200, 0, -50)
commandBarFrame.BackgroundColor3 = Theme.background
commandBarFrame.BorderSizePixel = 0
commandBarFrame.Parent = screenGui

local commandBarCorner = Instance.new("UICorner")
commandBarCorner.CornerRadius = UDim.new(0, 8)
commandBarCorner.Parent = commandBarFrame

local commandInput = Instance.new("TextBox")
commandInput.Size = UDim2.new(1, -80, 1, -10)
commandInput.Position = UDim2.new(0, 10, 0, 5)
commandInput.BackgroundColor3 = Theme.secondary
commandInput.BorderSizePixel = 0
commandInput.Text = ""
commandInput.PlaceholderText = "Enter command..."
commandInput.TextColor3 = Theme.text
commandInput.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
commandInput.TextSize = 14
commandInput.Font = Enum.Font.SourceSans
commandInput.ClearTextOnFocus = false
commandInput.Parent = commandBarFrame

local inputCorner = Instance.new("UICorner")
inputCorner.CornerRadius = UDim.new(0, 6)
inputCorner.Parent = commandInput

local executeButton = Instance.new("TextButton")
executeButton.Size = UDim2.new(0, 60, 1, -10)
executeButton.Position = UDim2.new(1, -70, 0, 5)
executeButton.BackgroundColor3 = Theme.accent
executeButton.Text = "Execute"
executeButton.TextColor3 = Theme.text
executeButton.TextSize = 12
executeButton.Font = Enum.Font.SourceSansBold
executeButton.BorderSizePixel = 0
executeButton.Parent = commandBarFrame

local executeCorner = Instance.new("UICorner")
executeCorner.CornerRadius = UDim.new(0, 6)
executeCorner.Parent = executeButton

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 400, 0, 600)
mainFrame.Position = UDim2.new(0.5, -200, 0.5, -300)
mainFrame.BackgroundColor3 = Theme.background
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 12)
mainCorner.Parent = mainFrame

-- Header
local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 40)
header.BackgroundColor3 = Theme.secondary
header.BorderSizePixel = 0
header.Parent = mainFrame

local headerCorner = Instance.new("UICorner")
headerCorner.CornerRadius = UDim.new(0, 12)
headerCorner.Parent = header

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -40, 1, 0)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Text = "2take1 Hub 2025"
title.TextColor3 = Theme.text
title.TextSize = 16
title.Font = Enum.Font.SourceSansBold
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = header

local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 30, 0, 30)
closeButton.Position = UDim2.new(1, -35, 0, 5)
closeButton.BackgroundColor3 = Theme.danger
closeButton.Text = "X"
closeButton.TextColor3 = Theme.text
closeButton.TextSize = 14
closeButton.Font = Enum.Font.SourceSansBold
closeButton.Parent = header

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 6)
closeCorner.Parent = closeButton

-- Content
local content = Instance.new("ScrollingFrame")
content.Size = UDim2.new(1, -20, 1, -60)
content.Position = UDim2.new(0, 10, 0, 50)
content.BackgroundColor3 = Theme.secondary
content.BorderSizePixel = 0
content.ScrollBarThickness = 6
content.CanvasSize = UDim2.new(0, 0, 0, 1200)
content.Parent = mainFrame

local contentCorner = Instance.new("UICorner")
contentCorner.CornerRadius = UDim.new(0, 8)
contentCorner.Parent = content

local layout = Instance.new("UIListLayout")
layout.Padding = UDim.new(0, 10)
layout.Parent = content

-- Stats Frame
local statsFrame = Instance.new("Frame")
statsFrame.Size = UDim2.new(1, -10, 0, 150)
statsFrame.BackgroundColor3 = Theme.tertiary
statsFrame.BorderSizePixel = 0
statsFrame.Parent = content

local statsCorner = Instance.new("UICorner")
statsCorner.CornerRadius = UDim.new(0, 8)
statsCorner.Parent = statsFrame

local statsTitle = Instance.new("TextLabel")
statsTitle.Size = UDim2.new(1, -10, 0, 25)
statsTitle.Position = UDim2.new(0, 5, 0, 5)
statsTitle.BackgroundTransparency = 1
statsTitle.Text = "üìä Player Stats"
statsTitle.TextColor3 = Theme.accent
statsTitle.TextSize = 16
statsTitle.Font = Enum.Font.SourceSansBold
statsTitle.TextXAlignment = Enum.TextXAlignment.Left
statsTitle.Parent = statsFrame

-- Stats Labels
local powerLabel = Instance.new("TextLabel")
powerLabel.Size = UDim2.new(0.48, 0, 0, 20)
powerLabel.Position = UDim2.new(0, 10, 0, 30)
powerLabel.BackgroundTransparency = 1
powerLabel.Text = "‚ö° Power: 0"
powerLabel.TextColor3 = Theme.text
powerLabel.TextSize = 12
powerLabel.Font = Enum.Font.SourceSans
powerLabel.TextXAlignment = Enum.TextXAlignment.Left
powerLabel.Parent = statsFrame

local killsLabel = Instance.new("TextLabel")
killsLabel.Size = UDim2.new(0.48, 0, 0, 20)
killsLabel.Position = UDim2.new(0.52, 0, 0, 30)
killsLabel.BackgroundTransparency = 1
killsLabel.Text = "üíÄ Kills: 0"
killsLabel.TextColor3 = Theme.text
killsLabel.TextSize = 12
killsLabel.Font = Enum.Font.SourceSans
killsLabel.TextXAlignment = Enum.TextXAlignment.Left
killsLabel.Parent = statsFrame

local healthLabel = Instance.new("TextLabel")
healthLabel.Size = UDim2.new(0.48, 0, 0, 20)
healthLabel.Position = UDim2.new(0, 10, 0, 55)
healthLabel.BackgroundTransparency = 1
healthLabel.Text = "‚ù§Ô∏è Health: 100"
healthLabel.TextColor3 = Theme.text
healthLabel.TextSize = 12
healthLabel.Font = Enum.Font.SourceSans
healthLabel.TextXAlignment = Enum.TextXAlignment.Left
healthLabel.Parent = statsFrame

local powerPerSecLabel = Instance.new("TextLabel")
powerPerSecLabel.Size = UDim2.new(0.48, 0, 0, 20)
powerPerSecLabel.Position = UDim2.new(0.52, 0, 0, 55)
powerPerSecLabel.BackgroundTransparency = 1
powerPerSecLabel.Text = "‚è±Ô∏è Power/sec: 0"
powerPerSecLabel.TextColor3 = Theme.text
powerPerSecLabel.TextSize = 12
powerPerSecLabel.Font = Enum.Font.SourceSans
powerPerSecLabel.TextXAlignment = Enum.TextXAlignment.Left
powerPerSecLabel.Parent = statsFrame

local powerPerHourLabel = Instance.new("TextLabel")
powerPerHourLabel.Size = UDim2.new(0.48, 0, 0, 20)
powerPerHourLabel.Position = UDim2.new(0, 10, 0, 80)
powerPerHourLabel.BackgroundTransparency = 1
powerPerHourLabel.Text = "üïê Power/hour: 0"
powerPerHourLabel.TextColor3 = Theme.text
powerPerHourLabel.TextSize = 12
powerPerHourLabel.Font = Enum.Font.SourceSans
powerPerHourLabel.TextXAlignment = Enum.TextXAlignment.Left
powerPerHourLabel.Parent = statsFrame

local sessionLabel = Instance.new("TextLabel")
sessionLabel.Size = UDim2.new(0.48, 0, 0, 20)
sessionLabel.Position = UDim2.new(0.52, 0, 0, 80)
sessionLabel.BackgroundTransparency = 1
sessionLabel.Text = "üìà Session: +0"
sessionLabel.TextColor3 = Theme.text
sessionLabel.TextSize = 12
sessionLabel.Font = Enum.Font.SourceSans
sessionLabel.TextXAlignment = Enum.TextXAlignment.Left
sessionLabel.Parent = statsFrame

local sessionTimeLabel = Instance.new("TextLabel")
sessionTimeLabel.Size = UDim2.new(1, -20, 0, 20)
sessionTimeLabel.Position = UDim2.new(0, 10, 0, 105)
sessionTimeLabel.BackgroundTransparency = 1
sessionTimeLabel.Text = "‚è∞ Session Time: 00:00:00"
sessionTimeLabel.TextColor3 = Theme.text
sessionTimeLabel.TextSize = 12
sessionTimeLabel.Font = Enum.Font.SourceSans
sessionTimeLabel.TextXAlignment = Enum.TextXAlignment.Left
sessionTimeLabel.Parent = statsFrame

local efficiencyLabel = Instance.new("TextLabel")
efficiencyLabel.Size = UDim2.new(1, -20, 0, 20)
efficiencyLabel.Position = UDim2.new(0, 10, 0, 125)
efficiencyLabel.BackgroundTransparency = 1
efficiencyLabel.Text = "‚ö° Farm Efficiency: N/A"
efficiencyLabel.TextColor3 = Theme.accent
efficiencyLabel.TextSize = 12
efficiencyLabel.Font = Enum.Font.SourceSansBold
efficiencyLabel.TextXAlignment = Enum.TextXAlignment.Left
efficiencyLabel.Parent = statsFrame

-- Functions
local function notification(text)
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "2take1 Hub",
        Text = text,
        Duration = 3
    })
end

local function formatNumber(num)
    if num >= 1000000000 then
        return string.format("%.1fB", num / 1000000000)
    elseif num >= 1000000 then
        return string.format("%.1fM", num / 1000000)
    elseif num >= 1000 then
        return string.format("%.1fK", num / 1000)
    else
        return tostring(math.floor(num))
    end
end

local function formatTime(seconds)
    local hours = math.floor(seconds / 3600)
    local minutes = math.floor((seconds % 3600) / 60)
    local secs = math.floor(seconds % 60)
    return string.format("%02d:%02d:%02d", hours, minutes, secs)
end

local function updateStats()
    if not player.Character then return end
    
    local currentTime = tick()
    if currentTime - Stats.lastUpdateTime < 1 then return end
    Stats.lastUpdateTime = currentTime
    
    local leaderstats = player:FindFirstChild("leaderstats")
    if leaderstats then
        local powerStat = leaderstats:FindFirstChild("Power") or leaderstats:FindFirstChild("power") or leaderstats:FindFirstChild("Strength") or leaderstats:FindFirstChild("strength")
        if powerStat then
            local currentPower = powerStat.Value
            if Stats.lastPowerCheck > 0 and currentPower > Stats.lastPowerCheck then
                Stats.powerGainedThisSession = Stats.powerGainedThisSession + (currentPower - Stats.lastPowerCheck)
            end
            Stats.power = currentPower
            Stats.lastPowerCheck = currentPower
        end
        
        local killsStat = leaderstats:FindFirstChild("Kills") or leaderstats:FindFirstChild("kills") or leaderstats:FindFirstChild("KOs")
        if killsStat then Stats.kills = killsStat.Value end
    end
    
    pcall(function()
        local humanoid = player.Character:FindFirstChild("Humanoid")
        if humanoid then Stats.health = math.floor(humanoid.Health) end
    end)
    
    local sessionTime = currentTime - Stats.sessionStartTime
    if sessionTime > 5 then
        Stats.powerPerSecond = Stats.powerGainedThisSession / sessionTime
        Stats.powerPerHour = Stats.powerPerSecond * 3600
    end
    
    pcall(function()
        powerLabel.Text = "‚ö° Power: " .. formatNumber(Stats.power)
        killsLabel.Text = "üíÄ Kills: " .. formatNumber(Stats.kills)
        healthLabel.Text = "‚ù§Ô∏è Health: " .. Stats.health
        powerPerSecLabel.Text = "‚è±Ô∏è Power/sec: " .. formatNumber(Stats.powerPerSecond)
        powerPerHourLabel.Text = "üïê Power/hour: " .. formatNumber(Stats.powerPerHour)
        sessionLabel.Text = "üìà Session: +" .. formatNumber(Stats.powerGainedThisSession)
        sessionTimeLabel.Text = "‚è∞ Session Time: " .. formatTime(sessionTime)
        
        if State.health <= 25 then healthLabel.TextColor3 = Theme.danger
        elseif Stats.health <= 50 then healthLabel.TextColor3 = Theme.warning
        else healthLabel.TextColor3 = Theme.success end
    end)
end

local function getAllToolHandles()
    local handles = {}
    if not player.Character then return handles end
    
    for _, tool in pairs(player.Character:GetChildren()) do
        if tool:IsA("Tool") and tool:FindFirstChild("Handle") then
            table.insert(handles, tool.Handle)
        end
    end
    
    if player.Backpack then
        for _, tool in pairs(player.Backpack:GetChildren()) do
            if tool:IsA("Tool") and tool:FindFirstChild("Handle") then
                table.insert(handles, tool.Handle)
            end
        end
    end
    
    if #handles == 0 and workspace:FindFirstChild("load") and workspace.load:FindFirstChild("RemoteEvent") then
        pcall(function()
            workspace.load.RemoteEvent:FireServer()
        end)
        wait(0.5)
        if player.Backpack then
            for _, tool in pairs(player.Backpack:GetChildren()) do
                if tool:IsA("Tool") and tool:FindFirstChild("Handle") then
                    table.insert(handles, tool.Handle)
                end
            end
        end
    end
    
    return handles
end

-- Enhanced Kill Function with Death Verification
local function killPlayerWithVerification(targetPlayer)
    if not targetPlayer or not targetPlayer.Character or not targetPlayer.Character:FindFirstChild("Humanoid") then
        return false
    end
    
    local targetName = targetPlayer.Name
    local attempts = 0
    local maxAttempts = 10
    
    notification("Targeting " .. targetName .. " with verification...")
    
    spawn(function()
        while attempts < maxAttempts do
            if not targetPlayer or not targetPlayer.Parent or not targetPlayer.Character or not targetPlayer.Character:FindFirstChild("Humanoid") then
                break
            end
            
            local humanoid = targetPlayer.Character.Humanoid
            if humanoid.Health <= 0 then
                notification(targetName .. " eliminated successfully!")
                break
            end
            
            attempts = attempts + 1
            local handles = getAllToolHandles()
            
            if #handles == 0 then
                notification("No tools found!")
                break
            end
            
            for _, handle in pairs(handles) do
                if handle:FindFirstChild("dmg") then
                    pcall(function()
                        for i = 1, 3 do
                            handle.dmg.RemoteEvent:FireServer(humanoid, math.huge)
                        end
                    end)
                end
            end
            
            wait(0.2)
        end
        
        if attempts >= maxAttempts then
            notification("Max attempts reached for " .. targetName)
        end
    end)
    
    return true
end

-- Simple Kill Function (for Kill All button)
local function simpleKillPlayer(targetPlayer)
    if not targetPlayer or not targetPlayer.Character or not targetPlayer.Character:FindFirstChild("Humanoid") or targetPlayer == player then
        return false
    end
    
    local handles = getAllToolHandles()
    if #handles == 0 then return false end
    
    for _, handle in pairs(handles) do
        if handle:FindFirstChild("dmg") then
            pcall(function()
                for i = 1, 5 do
                    handle.dmg.RemoteEvent:FireServer(targetPlayer.Character.Humanoid, math.huge)
                end
            end)
        end
    end
    return true
end

local function godPlayer(target)
    local handles = getAllToolHandles()
    if #handles == 0 then return false end
    
    local targets = type(target) == "table" and target or {target}
    
    for _, handle in pairs(handles) do
        if handle:FindFirstChild("dmg") then
            for _, p in pairs(targets) do
                if p.Character and p.Character:FindFirstChild("Humanoid") then
                    pcall(function()
                        for i = 1, 10 do
                            handle.dmg.RemoteEvent:FireServer(p.Character.Humanoid, -math.huge)
                        end
                    end)
                end
            end
        end
    end
    return true
end

local function findPlayer(name)
    if not name then return nil end
    name = name:lower()
    
    if name == "me" then return player end
    if name == "all" then return Players:GetPlayers() end
    if name == "others" then
        local others = {}
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= player then table.insert(others, p) end
        end
        return others
    end
    
    for _, p in pairs(Players:GetPlayers()) do
        if p.Name:lower() == name or p.Name:lower():find(name) then
            return p
        end
    end
    
    return nil
end

local function showCommandBar()
    if State.commandBarVisible then return end
    State.commandBarVisible = true
    
    commandInput.Text = ""
    commandInput:CaptureFocus()
    
    TweenService:Create(commandBarFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {
        Position = UDim2.new(0.5, -200, 0, 20)
    }):Play()
end

local function hideCommandBar()
    if not State.commandBarVisible then return end
    State.commandBarVisible = false
    
    commandInput:ReleaseFocus()
    
    TweenService:Create(commandBarFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.In), {
        Position = UDim2.new(0.5, -200, 0, -50)
    }):Play()
end

local function executeCommand(command, commandPlayer)
    if not command or command == "" then return end
    
    local cmdPlayer = commandPlayer or player
    
    if command:sub(1, 1) == ";" then
        command = command:sub(2)
    end
    
    local args = command:split(" ")
    local cmd = args[1]:lower()
    
    local isAuthorized = (cmdPlayer == player) or table.find(Data.adminPlayers, cmdPlayer.Name)
    
    if cmd == "tp" or cmd == "teleport" then
        if args[2] then
            local target = findPlayer(args[2])
            if target and target ~= player and player.Character and player.Character:FindFirstChild("HumanoidRootPart") and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                player.Character.HumanoidRootPart.CFrame = target.Character.HumanoidRootPart.CFrame
                notification("Teleported to " .. target.Name)
            else
                notification("Player not found or invalid!")
            end
        else
            notification("Usage: tp [player]")
        end
        
    elseif cmd == "bring" and isAuthorized then
        if args[2] then
            local target = findPlayer(args[2])
            if target and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                if type(target) == "table" then
                    for _, p in pairs(target) do
                        if p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                            p.Character.HumanoidRootPart.CFrame = player.Character.HumanoidRootPart.CFrame
                        end
                    end
                    notification("Brought " .. #target .. " players")
                else
                    if target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                        target.Character.HumanoidRootPart.CFrame = player.Character.HumanoidRootPart.CFrame
                        notification("Brought " .. target.Name)
                    end
                end
            else
                notification("Invalid target!")
            end
        else
            notification("Usage: bring [player/all/others]")
        end
        
    -- ENHANCED KILL COMMAND with death verification
    elseif cmd == "kill" and isAuthorized then
        if args[2] then
            local target = findPlayer(args[2])
            if target then
                if type(target) == "table" then
                    for _, p in pairs(target) do
                        if p ~= player then
                            killPlayerWithVerification(p)
                        end
                    end
                else
                    if target ~= player then
                        killPlayerWithVerification(target)
                    end
                end
            else
                notification("Player not found!")
            end
        else
            notification("Usage: kill [player/all/others]")
        end
        
    elseif cmd == "god" and isAuthorized then
        local target = findPlayer(args[2] or "me")
        if target then
            if godPlayer(target) then
                local name = type(target) == "table" and (#target .. " players") or target.Name
                notification("God mode applied to " .. name)
            else
                notification("No damage tools found!")
            end
        else
            notification("Player not found!")
        end
        
    elseif cmd == "fly" then
        State.flying = not State.flying
        
        if State.flying then
            local char = player.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                local bv = Instance.new("BodyVelocity")
                bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
                bv.Velocity = Vector3.new(0, 0, 0)
                bv.Parent = char.HumanoidRootPart
                
                local bg = Instance.new("BodyGyro")
                bg.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
                bg.D = 500
                bg.P = 50000
                bg.Parent = char.HumanoidRootPart
                
                Data.flyObjects = {bv, bg}
            end
        else
            for _, obj in pairs(Data.flyObjects) do
                if obj then obj:Destroy() end
            end
            Data.flyObjects = {}
        end
        
        notification("Fly " .. (State.flying and "ON" or "OFF"))
        
    elseif cmd == "noclip" then
        State.noclip = not State.noclip
        notification("Noclip " .. (State.noclip and "ON" or "OFF"))
        
    elseif cmd == "speed" or cmd == "ws" then
        local speed = tonumber(args[2]) or 16
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid.WalkSpeed = speed
            Config.walkSpeed = speed
            notification("Speed set to " .. speed)
        end
        
    elseif cmd == "admin" and cmdPlayer == player then
        local target = findPlayer(args[2])
        if target then
            if not table.find(Data.adminPlayers, target.Name) then
                table.insert(Data.adminPlayers, target.Name)
                notification("Added " .. target.Name .. " as admin")
            else
                notification(target.Name .. " is already admin!")
            end
        else
            notification("Player not found!")
        end
        
    elseif cmd == "cmds" or cmd == "help" then
        notification("Commands: tp, bring, kill, god, fly, noclip, speed, admin")
        
    else
        if not isAuthorized and (cmd == "kill" or cmd == "god" or cmd == "bring") then
            notification("Access denied!")
        else
            notification("Unknown command: " .. cmd)
        end
    end
    
    hideCommandBar()
end

-- UI Functions
local function createToggle(text, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, -10, 0, 40)
    frame.BackgroundColor3 = Theme.tertiary
    frame.BorderSizePixel = 0
    frame.Parent = content
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -60, 1, 0)
    label.Position = UDim2.new(0, 10, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Theme.text
    label.TextSize = 14
    label.Font = Enum.Font.SourceSans
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    local toggle = Instance.new("TextButton")
    toggle.Size = UDim2.new(0, 40, 0, 20)
    toggle.Position = UDim2.new(1, -50, 0.5, -10)
    toggle.BackgroundColor3 = Theme.danger
    toggle.Text = "OFF"
    toggle.TextColor3 = Theme.text
    toggle.TextSize = 12
    toggle.Font = Enum.Font.SourceSansBold
    toggle.Parent = frame
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 4)
    toggleCorner.Parent = toggle
    
    local enabled = false
    toggle.MouseButton1Click:Connect(function()
        enabled = not enabled
        toggle.BackgroundColor3 = enabled and Theme.success or Theme.danger
        toggle.Text = enabled and "ON" or "OFF"
        callback(enabled)
    end)
    
    return frame
end

local function createToggleWithSpeed(text, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, -10, 0, 70)
    frame.BackgroundColor3 = Theme.tertiary
    frame.BorderSizePixel = 0
    frame.Parent = content
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -60, 0, 40)
    label.Position = UDim2.new(0, 10, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Theme.text
    label.TextSize = 14
    label.Font = Enum.Font.SourceSans
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    local toggle = Instance.new("TextButton")
    toggle.Size = UDim2.new(0, 40, 0, 20)
    toggle.Position = UDim2.new(1, -50, 0, 10)
    toggle.BackgroundColor3 = Theme.danger
    toggle.Text = "OFF"
    toggle.TextColor3 = Theme.text
    toggle.TextSize = 12
    toggle.Font = Enum.Font.SourceSansBold
    toggle.Parent = frame
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 4)
    toggleCorner.Parent = toggle
    
    local speedLabel = Instance.new("TextLabel")
    speedLabel.Size = UDim2.new(0, 60, 0, 25)
    speedLabel.Position = UDim2.new(0, 10, 0, 40)
    speedLabel.BackgroundTransparency = 1
    speedLabel.Text = "Speed:"
    speedLabel.TextColor3 = Theme.text
    speedLabel.TextSize = 12
    speedLabel.Font = Enum.Font.SourceSans
    speedLabel.TextXAlignment = Enum.TextXAlignment.Left
    speedLabel.Parent = frame
    
    local speedInput = Instance.new("TextBox")
    speedInput.Size = UDim2.new(0, 60, 0, 25)
    speedInput.Position = UDim2.new(0, 70, 0, 40)
    speedInput.BackgroundColor3 = Theme.secondary
    speedInput.BorderSizePixel = 0
    speedInput.Text = tostring(Config.speed)
    speedInput.TextColor3 = Theme.text
    speedInput.TextSize = 12
    speedInput.Font = Enum.Font.SourceSans
    speedInput.TextXAlignment = Enum.TextXAlignment.Center
    speedInput.Parent = frame
    
    local inputCorner = Instance.new("UICorner")
    inputCorner.CornerRadius = UDim.new(0, 4)
    inputCorner.Parent = speedInput
    
    local speedDisplay = Instance.new("TextLabel")
    speedDisplay.Size = UDim2.new(1, -140, 0, 25)
    speedDisplay.Position = UDim2.new(0, 135, 0, 40)
    speedDisplay.BackgroundTransparency = 1
    speedDisplay.Text = "‚âà " .. formatNumber(Config.speed * 3600) .. " power/hour"
    speedDisplay.TextColor3 = Theme.accent
    speedDisplay.TextSize = 11
    speedDisplay.Font = Enum.Font.SourceSans
    speedDisplay.TextXAlignment = Enum.TextXAlignment.Left
    speedDisplay.Parent = frame
    
    speedInput.FocusLost:Connect(function()
        local newSpeed = tonumber(speedInput.Text)
        if newSpeed and newSpeed > 0 and newSpeed <= 1000 then
            Config.speed = math.floor(newSpeed)
            speedInput.Text = tostring(Config.speed)
            notification("Speed set to " .. Config.speed)
            speedDisplay.Text = "‚âà " .. formatNumber(Config.speed * 3600) .. " power/hour"
        else
            speedInput.Text = tostring(Config.speed)
            notification("Invalid speed! Use 1-1000")
        end
    end)
    
    local enabled = false
    toggle.MouseButton1Click:Connect(function()
        enabled = not enabled
        toggle.BackgroundColor3 = enabled and Theme.success or Theme.danger
        toggle.Text = enabled and "ON" or "OFF"
        callback(enabled)
    end)
end

local function createButton(text, callback)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(1, -10, 0, 40)
    button.BackgroundColor3 = Theme.accent
    button.Text = text
    button.TextColor3 = Theme.text
    button.TextSize = 14
    button.Font = Enum.Font.SourceSansBold
    button.BorderSizePixel = 0
    button.Parent = content
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = button
    
    button.MouseButton1Click:Connect(callback)
end

-- Create UI Elements
createToggleWithSpeed("Fast Farm", function(enabled)
    State.fastFarm = enabled
    notification("Fast Farm " .. (enabled and "ON" or "OFF"))
end)

createToggle("Slow Farm", function(enabled)
    State.slowFarm = enabled
    notification("Slow Farm " .. (enabled and "ON" or "OFF"))
end)

-- Fixed Godmode toggle with proper looping
createToggle("Godmode", function(enabled)
    State.godMode = enabled
    notification("Godmode " .. (enabled and "ON" or "OFF"))
    
    if enabled then
        spawn(function()
            while State.godMode do
                godPlayer(player)
                wait(0)
            end
        end)
    end
end)

createToggle("Kill Aura", function(enabled)
    State.killAura = enabled
    notification("Kill Aura " .. (enabled and "ON" or "OFF"))
end)

-- Simple Kill All button (no verification text)
createButton("Kill All", function()
    local count = 0
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= player and simpleKillPlayer(p) then
            count = count + 1
        end
    end
    
    if count > 0 then
        notification("Attacked " .. count .. " players")
    else
        notification("No valid targets or tools found!")
    end
end)

createButton("God All", function()
    local success = godPlayer(Players:GetPlayers())
    notification(success and "God applied to all players" or "No tools found!")
end)

createButton("Reset Stats", function()
    Stats.powerGainedThisSession = 0
    Stats.sessionStartTime = tick()
    Stats.lastPowerCheck = Stats.power
    notification("Stats reset!")
end)

-- Event Connections
executeButton.MouseButton1Click:Connect(function()
    executeCommand(commandInput.Text)
end)

commandInput.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        executeCommand(commandInput.Text)
    else
        hideCommandBar()
    end
end)

UIS.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.Semicolon then
        showCommandBar()
    elseif input.KeyCode == Enum.KeyCode.Escape and State.commandBarVisible then
        hideCommandBar()
    end
end)

closeButton.MouseButton1Click:Connect(function()
    screenGui:Destroy()
end)

-- Main Loop
RunService.Heartbeat:Connect(function()
    if tick() % 1 < 0.016 then updateStats() end
    
    if not player.Character then return end
    local char = player.Character
    local humanoid = char:FindFirstChild("Humanoid")
    local rootPart = char:FindFirstChild("HumanoidRootPart")
    if not humanoid or not rootPart then return end
    
    -- Fast Farm
    if State.fastFarm then
        local handles = getAllToolHandles()
        for _, handle in pairs(handles) do
            if handle:FindFirstChild("up") then
                pcall(function()
                    for i = 1, Config.speed do
                        handle.up.RemoteEvent:FireServer()
                    end
                end)
            end
        end
    end
    
    -- Slow Farm
    if State.slowFarm then
        local handles = getAllToolHandles()
        for _, handle in pairs(handles) do
            if handle:FindFirstChild("up") then
                pcall(function()
                    handle.up.RemoteEvent:FireServer()
                end)
            end
        end
    end
    
    -- Kill Aura
    if State.killAura then
        local handles = getAllToolHandles()
        for _, handle in pairs(handles) do
            if handle:FindFirstChild("dmg") then
                for _, v in pairs(workspace:GetChildren()) do
                    if v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") and v ~= char then
                        local isProtected = false
                        for _, p in pairs(Players:GetPlayers()) do
                            if p.Character == v and (table.find(Data.adminPlayers, p.Name) or p == player) then
                                isProtected = true
                                break
                            end
                        end
                        
                        if not isProtected then
                            local distance = (rootPart.Position - v.HumanoidRootPart.Position).Magnitude
                            if distance <= Config.range then
                                pcall(function()
                                    handle.dmg.RemoteEvent:FireServer(v.Humanoid, math.huge)
                                end)
                            end
                        end
                    end
                end
            end
        end
    end
    
    -- Fly
    if State.flying and Data.flyObjects[1] and Data.flyObjects[2] then
        local bv = Data.flyObjects[1]
        local bg = Data.flyObjects[2]
        
        if bv.Parent and bg.Parent then
            local camera = workspace.CurrentCamera
            local moveVector = Vector3.new(0, 0, 0)
            
            if UIS:IsKeyDown(Enum.KeyCode.W) then
                moveVector = moveVector + camera.CFrame.LookVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.S) then
                moveVector = moveVector - camera.CFrame.LookVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.A) then
                moveVector = moveVector - camera.CFrame.RightVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.D) then
                moveVector = moveVector + camera.CFrame.RightVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.Space) then
                moveVector = moveVector + Vector3.new(0, 1, 0)
            end
            if UIS:IsKeyDown(Enum.KeyCode.LeftShift) then
                moveVector = moveVector - Vector3.new(0, 1, 0)
            end
            
            bv.Velocity = moveVector * Config.flySpeed
            bg.CFrame = camera.CFrame
        end
    end
    
    -- Noclip
    if State.noclip then
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
    end
end)

-- Character setup
player.CharacterAdded:Connect(function(char)
    wait(1)
    local humanoid = char:WaitForChild("Humanoid")
    humanoid.WalkSpeed = Config.walkSpeed
    humanoid.JumpPower = Config.jumpPower
end)

-- Chat commands
player.Chatted:Connect(function(msg)
    if msg:sub(1, 1) == Config.commandPrefix then
        executeCommand(msg)
    end
end)

-- Setup
table.insert(Data.adminPlayers, player.Name)

spawn(function()
    wait(2)
    if player:FindFirstChild("leaderstats") then
        local leaderstats = player.leaderstats
        local powerStat = leaderstats:FindFirstChild("Power") or leaderstats:FindFirstChild("power") or leaderstats:FindFirstChild("Strength") or leaderstats:FindFirstChild("strength")
        if powerStat then
            Stats.lastPowerCheck = powerStat.Value
            Stats.power = powerStat.Value
        end
    end
end)

notification("2take1 Hub Loaded!")
wait(1)
wait(1)
notification("Press ; for commands!")

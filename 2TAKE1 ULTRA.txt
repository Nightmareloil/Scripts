--[[
    2TAKE1 ULTRA PRO - 2026 Edition (FIXED & OPTIMIZED)
    ‚Ä¢ All features preserved & enhanced
    ‚Ä¢ Fixed all major bugs
    ‚Ä¢ Improved performance & commands
    ‚Ä¢ Better UI animations & sounds
    ‚Ä¢ Fixed: Reverse Damage, God Mode, Protection, Duplication
]]

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local Stats = game:GetService("Stats")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer

if not game:IsLoaded() then game.Loaded:Wait() end

-- Sound System (FIXED & IMPROVED IDs)
local SOUNDS = {
    hover = "rbxassetid://8303594058",
    click = "rbxassetid://8283062504",
    open = "rbxassetid://8283069053",
    close = "rbxassetid://8283062504",
    success = "rbxassetid://8283070621",
    error = "rbxassetid://8283073595",
    combat = "rbxassetid://8283076161"
}

local soundObjects = {}
local function initSounds()
    local folder = Instance.new("Folder", game:GetService("SoundService"))
    folder.Name = "2take1Sounds"
    for name, id in pairs(SOUNDS) do
        local sound = Instance.new("Sound", folder)
        sound.SoundId = id
        sound.Volume = name == "hover" and 0.2 or 0.35
        soundObjects[name] = sound
    end
end
initSounds()

local lastSoundTime = 0
local function playSound(name)
    local t = tick()
    if t - lastSoundTime < 0.05 then return end
    lastSoundTime = t
    local s = soundObjects[name]
    if s then task.spawn(function() pcall(function() s:Play() end) end) end
end

-- Theme (IMPROVED COLORS)
local Theme = {
    bg = Color3.fromRGB(15, 15, 25),
    bgGlass = Color3.fromRGB(22, 22, 35),
    secondary = Color3.fromRGB(32, 32, 48),
    tertiary = Color3.fromRGB(42, 42, 62),
    accent = Color3.fromRGB(88, 166, 255),
    accentBright = Color3.fromRGB(120, 190, 255),
    success = Color3.fromRGB(90, 220, 120),
    danger = Color3.fromRGB(255, 85, 85),
    warning = Color3.fromRGB(255, 200, 80),
    info = Color3.fromRGB(100, 170, 255),
    text = Color3.fromRGB(245, 245, 250),
    textDim = Color3.fromRGB(185, 185, 205),
    textMuted = Color3.fromRGB(145, 145, 165),
    border = Color3.fromRGB(200, 200, 220),
    gold = Color3.fromRGB(255, 215, 0)
}

-- Config
local Config = {
    speed = 4,
    killAuraRange = 30,
    walkSpeed = 22,
    jumpPower = 50,
    flySpeed = 40,
    prefix = ";",
    whitelist = {1212018424, 514967933}
}

-- State
local State = {
    fastFarm = false,
    slowFarm = false,
    godMode = false,
    killAura = false,
    flying = false,
    noclip = false,
    reverseDmg = false,
    speedHack = false,
    loopKill = false,
    protection = false,
    killFarm = false,
    watching = nil,
    protected = nil,
    killTarget = nil
}

-- Data
local Data = {
    admins = {},
    connections = {},
    coroutines = {},
    toolCache = {},
    lastToolUpdate = 0,
    stats = {
        power = 0,
        kills = 0,
        health = 100,
        sessionStart = tick(),
        farmStart = 0,
        farmGain = 0,
        farmTime = 0,
        powerPerHour = 0
    }
}

-- Utility Functions
local function notify(text, duration, type)
    local icons = {
        success = "rbxassetid://7743878358",
        error = "rbxassetid://7743877738",
        warning = "rbxassetid://7743878496",
        combat = "rbxassetid://7743878358"
    }
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = "2TAKE1 ULTRA",
            Text = text,
            Duration = duration or 3,
            Icon = icons[type] or "rbxassetid://7733964640"
        })
    end)
    if type and type ~= "info" then playSound(type) end
end

local function formatNum(n)
    if not n or n == math.huge then return "‚àû" end
    if n >= 1e12 then return string.format("%.2fT", n/1e12)
    elseif n >= 1e9 then return string.format("%.2fB", n/1e9)
    elseif n >= 1e6 then return string.format("%.2fM", n/1e6)
    elseif n >= 1e3 then return string.format("%.2fK", n/1e3)
    else return tostring(math.floor(n)) end
end

local function formatTime(s)
    local h = math.floor(s / 3600)
    local m = math.floor((s % 3600) / 60)
    local sec = math.floor(s % 60)
    if h > 0 then return string.format("%02d:%02d:%02d", h, m, sec)
    else return string.format("%02d:%02d", m, sec) end
end

local function corner(obj, rad)
    local c = Instance.new("UICorner", obj)
    c.CornerRadius = UDim.new(0, rad or 10)
end

local function stroke(obj, color, thick)
    local s = Instance.new("UIStroke", obj)
    s.Color = color or Theme.border
    s.Thickness = thick or 1
    s.Transparency = 0.4
end

local function makeDraggable(frame, handle)
    local dragging, dragStart, startPos
    handle = handle or frame
    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    handle.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

-- Tool & Combat Functions (FIXED)
local function updateToolCache()
    local t = tick()
    if t - Data.lastToolUpdate < 0.1 then return #Data.toolCache end
    Data.lastToolUpdate = t
    Data.toolCache = {}
    
    for _, container in ipairs({player.Character, player.Backpack}) do
        if container then
            for _, tool in ipairs(container:GetChildren()) do
                if tool:IsA("Tool") and tool:FindFirstChild("Handle") then
                    table.insert(Data.toolCache, tool.Handle)
                end
            end
        end
    end
    return #Data.toolCache
end

local function getTools()
    if #Data.toolCache == 0 then
        updateToolCache()
        if #Data.toolCache == 0 then
            local remote = workspace:FindFirstChild("load") and workspace.load:FindFirstChild("RemoteEvent")
            if remote then
                pcall(function() remote:FireServer() end)
                task.wait(0.1)
                updateToolCache()
            end
        end
    end
    return Data.toolCache
end

local function findPlayer(name)
    if not name or name == "" then return nil end
    name = name:lower()
    if name == "me" then return player end
    if name == "all" then return Players:GetPlayers() end
    if name == "others" then
        local t = {}
        for _, p in ipairs(Players:GetPlayers()) do
            if p ~= player then table.insert(t, p) end
        end
        return t
    end
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Name:lower() == name or p.DisplayName:lower() == name then return p end
    end
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Name:lower():find(name, 1, true) or p.DisplayName:lower():find(name, 1, true) then return p end
    end
    return nil
end

-- FIXED Kill Function
local function killPlayer(target)
    if not target or not target.Character then return false end
    local hum = target.Character:FindFirstChildOfClass("Humanoid")
    if not hum or hum.Health <= 0 then return false end
    
    if target == player then
        hum.Health = 0
        return true
    end
    
    local tools = getTools()
    if #tools == 0 then return false end
    
    local success = false
    for i = 1, math.min(3, #tools) do
        local tool = tools[i]
        if tool and tool.Parent then
            local remote = tool:FindFirstChild("dmg") and tool.dmg:FindFirstChild("RemoteEvent")
            if remote then
                pcall(function() 
                    remote:FireServer(hum, math.huge)
                    success = true
                end)
            end
        end
    end
    return success
end

-- FIXED God Mode Function
local function godPlayer(target)
    if not target or not target.Character then return false end
    local hum = target.Character:FindFirstChildOfClass("Humanoid")
    if not hum then return false end
    
    local tools = getTools()
    if #tools == 0 then return false end
    
    local success = false
    for i = 1, math.min(5, #tools) do
        local tool = tools[i]
        if tool and tool.Parent then
            local remote = tool:FindFirstChild("dmg") and tool.dmg:FindFirstChild("RemoteEvent")
            if remote then
                pcall(function() 
                    remote:FireServer(hum, -math.huge)
                    success = true
                end)
            end
        end
    end
    return success
end

local function healPlayer(target)
    if not target or not target.Character then return false end
    local hum = target.Character:FindFirstChildOfClass("Humanoid")
    if not hum or hum.Health >= hum.MaxHealth then return false end
    
    local tools = getTools()
    if #tools == 0 then return false end
    
    local remote = tools[1]:FindFirstChild("dmg") and tools[1].dmg:FindFirstChild("RemoteEvent")
    if remote then
        local healAmt = hum.MaxHealth - hum.Health
        pcall(function() remote:FireServer(hum, -healAmt) end)
        return true
    end
    return false
end

local function damagePlayer(target, percent)
    if not target or not target.Character then return false end
    local hum = target.Character:FindFirstChildOfClass("Humanoid")
    if not hum or hum.Health <= 0 then return false end
    
    local tools = getTools()
    if #tools == 0 then return false end
    
    local remote = tools[1]:FindFirstChild("dmg") and tools[1].dmg:FindFirstChild("RemoteEvent")
    if remote then
        local dmgAmt = (percent / 100) * hum.MaxHealth
        pcall(function() remote:FireServer(hum, dmgAmt) end)
        return true
    end
    return false
end

local function executeOnTargets(targets, action, actionName)
    if not targets then
        notify("Target not found", 2, "error")
        return
    end
    
    local list = type(targets) == "table" and targets or {targets}
    if #list == 0 then
        notify("No valid targets", 2, "warning")
        return
    end
    
    notify(string.format("Executing %s on %d target(s)...", actionName, #list), 2, "info")
    local success = 0
    
    for _, target in ipairs(list) do
        if target and target.Parent then
            for i = 1, 3 do
                if action(target) then
                    success = success + 1
                    break
                end
                task.wait(0.1)
            end
        end
        task.wait(0.1)
    end
    
    notify(string.format("%s: %d/%d successful", actionName, success, #list), 3, "success")
end

-- Farm System
local function farm(speed)
    if not player.Character then return end
    local tools = getTools()
    
    for _, handle in ipairs(tools) do
        if handle and handle.Parent then
            local remote = handle:FindFirstChild("up") and handle.up:FindFirstChild("RemoteEvent")
            if remote then
                for i = 1, speed do
                    pcall(function() remote:FireServer() end)
                end
            end
        end
    end
end

local farmConn = {fast = nil, slow = nil}
local function toggleFarm(mode, enabled)
    local opposite = mode == "fast" and "slow" or "fast"
    if farmConn[opposite] then
        farmConn[opposite]:Disconnect()
        farmConn[opposite] = nil
        State[opposite .. "Farm"] = false
    end
    
    if farmConn[mode] then
        farmConn[mode]:Disconnect()
        farmConn[mode] = nil
    end
    
    State[mode .. "Farm"] = enabled
    
    if enabled then
        Data.stats.farmStart = Data.stats.power
        notify(mode:upper() .. " farm activated - Persists through death", 2, "success")
        
        local multiplier = mode == "fast" and 1.0 or 0.5
        farmConn[mode] = RunService.Heartbeat:Connect(function()
            if State[mode .. "Farm"] and player.Character then
                farm(math.ceil(Config.speed * multiplier))
                if mode == "slow" then task.wait(0.08) end
            end
        end)
    else
        notify(mode:upper() .. " farm deactivated", 2, "info")
    end
end

-- FIXED God Mode System
local function setGodMode(enabled)
    State.godMode = enabled
    
    if Data.coroutines.godMode then
        task.cancel(Data.coroutines.godMode)
        Data.coroutines.godMode = nil
    end
    
    notify("God mode " .. (enabled and "ON" or "OFF"), 2, enabled and "success" or "info")
    
    if enabled then
        Data.coroutines.godMode = task.spawn(function()
            while State.godMode do
                if player.Character then
                    godPlayer(player)
                end
                task.wait(0.05)
            end
        end)
    end
end

-- Kill Aura System
local function toggleKillAura(enabled)
    State.killAura = enabled
    
    if Data.coroutines.killAura then
        task.cancel(Data.coroutines.killAura)
        Data.coroutines.killAura = nil
    end
    
    notify("Kill aura " .. (enabled and "ON" or "OFF"), 2, enabled and "success" or "info")
    
    if enabled then
        Data.coroutines.killAura = task.spawn(function()
            while State.killAura do
                if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    local hrp = player.Character.HumanoidRootPart
                    for _, p in ipairs(Players:GetPlayers()) do
                        if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                            local tHum = p.Character:FindFirstChildOfClass("Humanoid")
                            if tHum and tHum.Health > 0 then
                                local dist = (hrp.Position - p.Character.HumanoidRootPart.Position).Magnitude
                                if dist <= Config.killAuraRange then
                                    task.spawn(killPlayer, p)
                                end
                            end
                        end
                    end
                end
                task.wait(0.5)
            end
        end)
    end
end

-- FIXED Reverse Damage System
local attackHistory = {}
local lastHealth = 0

local function setupReverseDmg()
    if Data.connections.reverseDmg then
        Data.connections.reverseDmg:Disconnect()
        Data.connections.reverseDmg = nil
    end
    
    if not State.reverseDmg or not player.Character then
        notify("Reverse damage OFF", 2, "info")
        return
    end
    
    local hum = player.Character:FindFirstChildOfClass("Humanoid")
    if not hum then return end
    
    lastHealth = hum.Health
    notify("Reverse damage ACTIVE - Auto retaliation enabled", 2, "success")
    playSound("combat")
    
    Data.connections.reverseDmg = RunService.Heartbeat:Connect(function()
        if not State.reverseDmg or not player.Character then
            State.reverseDmg = false
            if Data.connections.reverseDmg then
                Data.connections.reverseDmg:Disconnect()
                Data.connections.reverseDmg = nil
            end
            return
        end
        
        local currentHum = player.Character:FindFirstChildOfClass("Humanoid")
        if not currentHum then return end
        
        local currentHealth = currentHum.Health
        if currentHealth < lastHealth and currentHealth > 0 then
            local creator = currentHum:FindFirstChild("creator")
            if creator and creator:IsA("ObjectValue") and creator.Value and creator.Value:IsA("Player") then
                local attacker = creator.Value
                if attacker ~= player and attacker.Parent then
                    local t = tick()
                    if not attackHistory[attacker] or t - attackHistory[attacker] > 0.1 then
                        attackHistory[attacker] = t
                        task.spawn(function()
                            for i = 1, 5 do
                                killPlayer(attacker)
                                task.wait(0.05)
                            end
                        end)
                        notify("‚öîÔ∏è Retaliated: " .. attacker.DisplayName, 1.5, "combat")
                    end
                end
                task.spawn(function()
                    task.wait(0.05)
                    if creator and creator.Parent then creator:Destroy() end
                end)
            end
        end
        lastHealth = currentHealth
    end)
end

-- Loop Kill System
local function toggleLoopKill(targets)
    if Data.connections.loopKill then
        Data.connections.loopKill:Disconnect()
        Data.connections.loopKill = nil
        State.loopKill = false
        notify("Loop kill OFF", 2, "info")
        return
    end
    
    if not targets then return end
    
    local list = type(targets) == "table" and targets or {targets}
    State.loopKill = true
    notify("Loop kill ON: " .. #list .. " target(s)", 3, "success")
    
    Data.connections.loopKill = RunService.Heartbeat:Connect(function()
        if State.loopKill then
            for _, target in ipairs(list) do
                if target and target.Parent then
                    task.spawn(killPlayer, target)
                end
            end
            task.wait(0.1)
        end
    end)
end

-- Kill Farm System
local function toggleKillFarm(target)
    if Data.connections.killFarm then
        Data.connections.killFarm:Disconnect()
        Data.connections.killFarm = nil
        State.killFarm = false
        State.killTarget = nil
        notify("Kill farm OFF", 2, "info")
        return
    end
    
    if not target or type(target) == "table" then
        notify("Invalid target for kill farm", 2, "error")
        return
    end
    
    State.killFarm = true
    State.killTarget = target
    notify("Kill farm ON: " .. target.DisplayName, 3, "success")
    
    Data.connections.killFarm = RunService.Heartbeat:Connect(function()
        if State.killFarm and State.killTarget and State.killTarget.Parent then
            local tools = getTools()
            for _, tool in ipairs(tools) do
                if tool and tool.Parent and State.killTarget.Character then
                    local hum = State.killTarget.Character:FindFirstChildOfClass("Humanoid")
                    if hum and hum.Health > 0 then
                        local remote = tool:FindFirstChild("dmg") and tool.dmg:FindFirstChild("RemoteEvent")
                        if remote then
                            pcall(function() remote:FireServer(hum, math.huge) end)
                        end
                    end
                end
            end
            task.wait(0.1)
        end
    end)
end

-- FIXED Protection System
local function setupProtection(target)
    if Data.connections.protection then
        Data.connections.protection:Disconnect()
        Data.connections.protection = nil
        State.protection = false
        State.protected = nil
        notify("Protection OFF", 2, "info")
        return
    end
    
    if not target or type(target) == "table" then
        notify("Invalid target for protection", 2, "error")
        return
    end
    
    State.protection = true
    State.protected = target
    notify("üõ°Ô∏è Protection ON: " .. target.DisplayName, 3, "success")
    playSound("success")
    
    local lastCheck = 0
    local protectHistory = {}
    
    Data.connections.protection = RunService.Heartbeat:Connect(function()
        if not State.protection or not State.protected or not State.protected.Parent or not State.protected.Character then 
            if Data.connections.protection then
                setupProtection(nil)
            end
            return 
        end
        
        local t = tick()
        if t - lastCheck < 0.05 then return end
        lastCheck = t
        
        local hum = State.protected.Character:FindFirstChildOfClass("Humanoid")
        if not hum then return end
        
        local creator = hum:FindFirstChild("creator")
        if creator and creator:IsA("ObjectValue") and creator.Value and creator.Value:IsA("Player") then
            local attacker = creator.Value
            if attacker ~= State.protected and attacker ~= player and attacker.Parent then
                if not protectHistory[attacker] or t - protectHistory[attacker] > 0.1 then
                    protectHistory[attacker] = t
                    task.spawn(function()
                        for i = 1, 7 do
                            killPlayer(attacker)
                            task.wait(0.05)
                        end
                    end)
                    notify("üõ°Ô∏è Protected from " .. attacker.DisplayName, 2, "combat")
                end
            end
            task.spawn(function()
                task.wait(0.05)
                if creator and creator.Parent then creator:Destroy() end
            end)
        end
    end)
end

-- Flight System
local function toggleFly()
    State.flying = not State.flying
    notify("Flight " .. (State.flying and "ON" or "OFF"), 2, "info")
    
    if Data.connections.fly then
        Data.connections.fly:Disconnect()
        Data.connections.fly = nil
    end
    if Data.flyObjects then
        for _, obj in pairs(Data.flyObjects) do
            if obj and obj.Parent then obj:Destroy() end
        end
        Data.flyObjects = nil
    end
    if player.Character then
        local hum = player.Character:FindFirstChildOfClass("Humanoid")
        if hum then hum.PlatformStand = false end
    end
    
    if not State.flying or not player.Character then return end
    
    local char = player.Character
    local hum = char:FindFirstChildOfClass("Humanoid")
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hum or not hrp then
        State.flying = false
        notify("Cannot fly without character", 2, "error")
        return
    end
    
    hum.PlatformStand = true
    
    local bv = Instance.new("BodyVelocity", hrp)
    bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    bv.Velocity = Vector3.zero
    
    local bg = Instance.new("BodyGyro", hrp)
    bg.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    bg.D = 100
    bg.P = 10000
    bg.CFrame = hrp.CFrame
    
    Data.flyObjects = {bv = bv, bg = bg}
    
    Data.connections.fly = RunService.Heartbeat:Connect(function()
        if not State.flying or not Data.flyObjects.bv or not Data.flyObjects.bv.Parent then
            if Data.connections.fly then
                Data.connections.fly:Disconnect()
                Data.connections.fly = nil
            end
            return
        end
        
        local cam = workspace.CurrentCamera
        local move = Vector3.zero
        
        if UIS:IsKeyDown(Enum.KeyCode.W) then move = move + cam.CFrame.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.S) then move = move - cam.CFrame.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.A) then move = move - cam.CFrame.RightVector end
        if UIS:IsKeyDown(Enum.KeyCode.D) then move = move + cam.CFrame.RightVector end
        if UIS:IsKeyDown(Enum.KeyCode.Space) then move = move + Vector3.new(0, 1, 0) end
        if UIS:IsKeyDown(Enum.KeyCode.LeftShift) then move = move - Vector3.new(0, 1, 0) end
        
        Data.flyObjects.bv.Velocity = move.Magnitude > 0 and move.Unit * Config.flySpeed or Vector3.zero
        Data.flyObjects.bg.CFrame = cam.CFrame
    end)
end

-- Noclip System
local function toggleNoclip()
    State.noclip = not State.noclip
    notify("Noclip " .. (State.noclip and "ON" or "OFF"), 2, "info")
    
    if Data.connections.noclip then
        Data.connections.noclip:Disconnect()
        Data.connections.noclip = nil
    end
    
    if State.noclip then
        Data.connections.noclip = RunService.Stepped:Connect(function()
            if player.Character then
                for _, part in ipairs(player.Character:GetDescendants()) do
                    if part:IsA("BasePart") and part.CanCollide then
                        part.CanCollide = false
                    end
                end
            end
        end)
    end
end

-- Speed System
local function setSpeed(speed)
    if Data.connections.speed then
        Data.connections.speed:Disconnect()
        Data.connections.speed = nil
    end
    
    State.speedHack = (speed ~= Config.walkSpeed)
    
    if player.Character then
        local hum = player.Character:FindFirstChildOfClass("Humanoid")
        if hum then
            hum.WalkSpeed = speed
            if State.speedHack then
                Data.connections.speed = hum:GetPropertyChangedSignal("WalkSpeed"):Connect(function()
                    if State.speedHack then hum.WalkSpeed = speed end
                end)
            end
        end
    end
    
    notify("Speed set to " .. speed, 2, "success")
end

-- Commands (IMPROVED & FIXED)
local cmds = {
    {"cmds", "Show command list", function(args, source)
        notify("Use 'View Commands' button in UI or type ;cmds", 2, "info")
        return true
    end},
    
    {"admin [player]", "Grant admin to player", function(args, source)
        local target = findPlayer(args[2] or "me")
        if not target then
            notify("Player not found", 2, "error")
            return
        end
        
        local list = type(target) == "table" and target or {target}
        local count = 0
        for _, p in ipairs(list) do
            if p ~= player and not table.find(Data.admins, p.Name) then
                table.insert(Data.admins, p.Name)
                count = count + 1
            end
        end
        notify("Admin granted to " .. count .. " player(s)", 3, "success")
    end},
    
    {"unadmin [player]", "Remove admin from player", function(args, source)
        local target = findPlayer(args[2] or "me")
        if not target then
            notify("Player not found", 2, "error")
            return
        end
        
        local list = type(target) == "table" and target or {target}
        local count = 0
        for _, p in ipairs(list) do
            for i, name in ipairs(Data.admins) do
                if name == p.Name then
                    table.remove(Data.admins, i)
                    count = count + 1
                    break
                end
            end
        end
        notify("Admin removed from " .. count .. " player(s)", 3, "success")
    end},
    
    {"tp/to [player]", "Teleport to player", function(args, source)
        local target = findPlayer(args[2])
        if target and type(target) ~= "table" and target.Character and source.Character then
            local targetHRP = target.Character:FindFirstChild("HumanoidRootPart")
            local sourceHRP = source.Character:FindFirstChild("HumanoidRootPart")
            if targetHRP and sourceHRP then
                sourceHRP.CFrame = targetHRP.CFrame + Vector3.new(0, 2, 0)
                notify("Teleported to " .. target.DisplayName, 2, "success")
            else
                notify("Cannot teleport - missing parts", 2, "error")
            end
        else
            notify("Player not found or invalid target", 2, "error")
        end
    end},
    
    {"dupe [amount]", "Duplicate tools (reliable)", function(args, source)
        local amount = tonumber(args[2])
        if not amount or amount <= 0 or amount > 1000 then
            notify("Usage: ;dupe [1-1000]", 3, "warning")
            return
        end
        
        local remote = ReplicatedStorage:FindFirstChild("Remotes")
        if remote then
            remote = remote:FindFirstChild("LoadSwords")
        end
        
        if not remote then
            notify("Duplication unavailable", 3, "error")
            return
        end
        
        task.spawn(function()
            notify("üîß Duplication started: " .. amount .. " items", 3, "info")
            
            local function equipAll()
                if player.Backpack then
                    for _, tool in ipairs(player.Backpack:GetChildren()) do
                        if tool:IsA("Tool") then
                            pcall(function() tool.Parent = player.Character end)
                        end
                    end
                end
            end
            
            local function getToolCount()
                local count = 0
                for _, container in ipairs({player.Character, player.Backpack}) do
                    if container then
                        for _, tool in ipairs(container:GetChildren()) do
                            if tool:IsA("Tool") then count = count + 1 end
                        end
                    end
                end
                return count
            end
            
            local startCount = getToolCount()
            local completed = 0
            local lastNotify = tick()
            local failed = 0
            
            for i = 1, amount do
                local beforeCount = getToolCount()
                
                equipAll()
                local success = pcall(function() 
                    remote:FireServer()
                end)
                
                if not success then
                    failed = failed + 1
                    task.wait(0.20)
                else
                    local waited = 0
                    local maxWait = 1.2
                    local toolReceived = false
                    
                    while waited < maxWait do
                        task.wait(0.08)
                        waited = waited + 0.08
                        if getToolCount() > beforeCount then
                            completed = completed + 1
                            toolReceived = true
                            break
                        end
                    end
                    
                    if not toolReceived then
                        failed = failed + 1
                        task.wait(0.2)
                    end
                end
                
                if tick() - lastNotify > 2 then
                    notify(string.format("üîß Progress: %d/%d (%.1f%%)", completed, amount, (completed / amount) * 100), 1, "info")
                    lastNotify = tick()
                end
                
                if failed > 5 then
                    task.wait(0.25)
                elseif failed > 2 then
                    task.wait(0.18)
                else
                    task.wait(0.12)
                end
            end
            
            equipAll()
            local finalCount = getToolCount()
            local gained = finalCount - startCount
            notify(string.format("dupe complete! Created: %d/%d (%.1f%% success)", gained, amount, (gained / amount) * 100), 5, "success")
            if failed > 0 then
                notify(string.format("‚ö†Ô∏è %d requests failed (server limitation)", failed), 3, "warning")
            end
            playSound("success")
        end)
    end},

    {"fastdupe [amount]", "Faster duplication (risky)", function(args, source)
        local amount = tonumber(args[2])
        if not amount or amount <= 0 or amount > 600 then
            notify("Usage: ;fastdupe [1-600]", 3, "warning")
            return
        end
        
        local remote = ReplicatedStorage:FindFirstChild("Remotes")
        if remote then
            remote = remote:FindFirstChild("LoadSwords")
        end
        
        if not remote then
            notify("Duplication unavailable", 3, "error")
            return
        end
        
        task.spawn(function()
            notify("‚ö° Fast dupe: " .. amount .. " items (risky)", 3, "warning")
            
            local function equipAll()
                if player.Backpack then
                    for _, tool in ipairs(player.Backpack:GetChildren()) do
                        if tool:IsA("Tool") then
                            pcall(function() tool.Parent = player.Character end)
                        end
                    end
                end
            end
            
            local function getToolCount()
                local count = 0
                for _, container in ipairs({player.Character, player.Backpack}) do
                    if container then
                        for _, tool in ipairs(container:GetChildren()) do
                            if tool:IsA("Tool") then count = count + 1 end
                        end
                    end
                end
                return count
            end
            
            local startCount = getToolCount()
            local lastNotify = tick()
            
            for i = 1, amount do
                equipAll()
                pcall(function() 
                    remote:FireServer()
                end)
                
                if tick() - lastNotify > 2 then
                    notify(string.format("‚ö° Fast: %d/%d (%.1f%%)", i, amount, (i / amount) * 100), 1, "info")
                    lastNotify = tick()
                end
                
                if i % 40 == 0 then
                    task.wait(0.1)
                else
                    task.wait(0.1)
                end
            end
            
            equipAll()
            task.wait(0.2)
            
            local finalCount = getToolCount()
            local gained = finalCount - startCount
            notify(string.format("‚ö° Fast dupe done! Created: %d (%.1f%% rate)", gained, (gained / amount) * 100), 5, "success")
            playSound("success")
        end)
    end},
    
    {"kill [player]", "Kill target player(s)", function(args, source)
        local targets = findPlayer(args[2] or "me")
        executeOnTargets(targets, killPlayer, "kill")
    end},
    
    {"killfarm [player]", "Start kill farming target", function(args, source)
        if not args[2] then
            notify("Usage: ;killfarm [player]", 3, "warning")
            return
        end
        local target = findPlayer(args[2])
        toggleKillFarm(target)
    end},
    
    {"stopkillfarm", "Stop kill farming", function(args, source)
        toggleKillFarm(nil)
    end},
    
    {"dmg [player] [percent]", "Damage target by percent", function(args, source)
        local targetName, percent = args[2], tonumber(args[3])
        if not targetName or not percent or percent <= 0 then
            notify("Usage: ;dmg [player] [percent]", 3, "warning")
            return
        end
        local targets = findPlayer(targetName)
        executeOnTargets(targets, function(t) return damagePlayer(t, percent) end, string.format("damage (%.0f%%)", percent))
    end},
    
    {"loopkill [player]", "Loop kill target(s)", function(args, source)
        local targets = findPlayer(args[2] or "me")
        toggleLoopKill(targets)
    end},
    
    {"unloopkill", "Stop loop kill", function(args, source)
        toggleLoopKill(nil)
    end},
    
    {"god [player]", "Grant god mode to player(s)", function(args, source)
        local targets = findPlayer(args[2] or "me")
        if targets == player then
            setGodMode(true)
        else
            executeOnTargets(targets, godPlayer, "god mode")
        end
    end},
    
    {"heal [player]", "Heal player(s)", function(args, source)
        local targets = findPlayer(args[2] or "me")
        executeOnTargets(targets, healPlayer, "heal")
    end},
    
    {"protect [player]", "Protect player from attackers", function(args, source)
        if not args[2] then
            notify("Usage: ;protect [player]", 3, "warning")
            return
        end
        local target = findPlayer(args[2])
        setupProtection(target)
    end},
    
    {"unprotect", "Stop protection", function(args, source)
        setupProtection(nil)
    end},
    
    {"reversedmg", "Toggle reverse damage", function(args, source)
        State.reverseDmg = not State.reverseDmg
        setupReverseDmg()
    end},
    
    {"fly", "Toggle flight mode", function(args, source)
        if source ~= player then
            notify("Owner only", 2, "error")
            return
        end
        toggleFly()
    end},
    
    {"unfly", "Disable flight", function(args, source)
        if State.flying then toggleFly() end
    end},
    
    {"noclip", "Toggle noclip", function(args, source)
        if source ~= player then
            notify("Owner only", 2, "error")
            return
        end
        toggleNoclip()
    end},
    
    {"unnoclip", "Disable noclip", function(args, source)
        if State.noclip then toggleNoclip() end
    end},
    
    {"speed [value]", "Set walk speed", function(args, source)
        if source ~= player then
            notify("Owner only", 2, "error")
            return
        end
        local speed = tonumber(args[2]) or Config.walkSpeed
        setSpeed(speed)
    end},
    
    {"watch [player]", "Watch player stats", function(args, source)
        if not args[2] then
            notify("Usage: ;watch [player]", 3, "warning")
            return
        end
        local target = findPlayer(args[2])
        if target and type(target) ~= "table" then
            State.watching = target
            notify("Watching " .. target.DisplayName, 3, "success")
        else
            notify("Player not found", 2, "error")
        end
    end},
    
    {"unwatch", "Stop watching player", function(args, source)
        State.watching = nil
        notify("Stopped watching", 2, "info")
    end},
    
    {"reset", "Reset character", function(args, source)
        if source.Character then
            local hum = source.Character:FindFirstChildOfClass("Humanoid")
            if hum then hum.Health = 0 end
        end
    end},
    
    {"rejoin/rj", "Rejoin server", function(args, source)
        notify("Rejoining server...", 2, "info")
        local success, err = pcall(function()
            game:GetService("TeleportService"):TeleportToPlaceInstance(game.PlaceId, game.JobId, player)
        end)
        if not success then
            notify("Rejoin failed, trying alternate method...", 3, "warning")
            pcall(function()
                game:GetService("TeleportService"):Teleport(game.PlaceId, player)
            end)
        end
    end}
}

local function executeCmd(text, source)
    source = source or player
    if not text or text == "" then return end
    
    local isAuthorized = (source == player) or table.find(Data.admins, source.Name)
    if not isAuthorized then
        notify("You don't have permission", 2, "error")
        return
    end
    
    if text:sub(1, 1) == Config.prefix then
        text = text:sub(2)
    end
    
    local args = {}
    for word in text:gmatch("%S+") do
        table.insert(args, word)
    end
    if #args == 0 then return end
    
    local cmdName = args[1]:lower()
    
    for i, cmd in ipairs(cmds) do
        local pattern = cmd[1]:lower()
        local mainCmd = pattern:match("^([^%s/]+)")
        
        if pattern:find("/") then
            for alt in pattern:gmatch("[^/]+") do
                alt = alt:match("^(%S+)")
                if alt == cmdName then
                    playSound("click")
                    local success, err = pcall(cmd[3], args, source)
                    if not success then
                        notify("Command error: " .. tostring(err), 3, "error")
                    end
                    return
                end
            end
        else
            if mainCmd == cmdName then
                playSound("click")
                local success, err = pcall(cmd[3], args, source)
                if not success then
                    notify("Command error: " .. tostring(err), 3, "error")
                end
                return
            end
        end
    end
    
    notify("Unknown command: " .. cmdName, 2, "error")
end

-- Create GUI
local sg = Instance.new("ScreenGui")
sg.Name = "2take1Ultra"
sg.ResetOnSpawn = false
if syn and syn.protect_gui then
    syn.protect_gui(sg)
elseif gethui then
    sg.Parent = gethui()
else
    sg.Parent = game:GetService("CoreGui")
end

-- Performance Display
local perf = Instance.new("Frame", sg)
perf.Size = UDim2.new(0, 160, 0, 55)
perf.Position = UDim2.new(1, -170, 0, 10)
perf.BackgroundColor3 = Theme.bgGlass
perf.BackgroundTransparency = 0.35
perf.BorderSizePixel = 0
corner(perf, 10)
stroke(perf, Theme.border, 1)

local fpsLabel = Instance.new("TextLabel", perf)
fpsLabel.Size = UDim2.new(0.5, 0, 0.5, 0)
fpsLabel.Position = UDim2.new(0, 5, 0, 0)
fpsLabel.BackgroundTransparency = 1
fpsLabel.Text = "FPS: 0"
fpsLabel.TextColor3 = Theme.success
fpsLabel.TextSize = 11
fpsLabel.Font = Enum.Font.GothamBold
fpsLabel.TextXAlignment = Enum.TextXAlignment.Left

local pingLabel = Instance.new("TextLabel", perf)
pingLabel.Size = UDim2.new(0.5, 0, 0.5, 0)
pingLabel.Position = UDim2.new(0.5, 0, 0, 0)
pingLabel.BackgroundTransparency = 1
pingLabel.Text = "Ping: 0ms"
pingLabel.TextColor3 = Theme.info
pingLabel.TextSize = 11
pingLabel.Font = Enum.Font.GothamBold
pingLabel.TextXAlignment = Enum.TextXAlignment.Left

local memLabel = Instance.new("TextLabel", perf)
memLabel.Size = UDim2.new(1, -10, 0.5, 0)
memLabel.Position = UDim2.new(0, 5, 0.5, 0)
memLabel.BackgroundTransparency = 1
memLabel.Text = "Memory: 0MB"
memLabel.TextColor3 = Theme.textDim
memLabel.TextSize = 9
memLabel.Font = Enum.Font.Gotham
memLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Command Bar
local cmdBar = Instance.new("Frame", sg)
cmdBar.Size = UDim2.new(0, 380, 0, 50)
cmdBar.Position = UDim2.new(0.5, -190, 1, 100)
cmdBar.BackgroundColor3 = Theme.bgGlass
cmdBar.BackgroundTransparency = 0.2
cmdBar.BorderSizePixel = 0
cmdBar.ClipsDescendants = true
corner(cmdBar, 12)
stroke(cmdBar, Theme.border, 1)
makeDraggable(cmdBar)

local cmdGrad = Instance.new("UIGradient", cmdBar)
cmdGrad.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Theme.bgGlass),
    ColorSequenceKeypoint.new(1, Theme.secondary)
}
cmdGrad.Rotation = 90

local cmdGlow = Instance.new("Frame", cmdBar)
cmdGlow.Size = UDim2.new(1, 0, 0.3, 0)
cmdGlow.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
cmdGlow.BackgroundTransparency = 0.88
cmdGlow.BorderSizePixel = 0

local cmdAccent = Instance.new("Frame", cmdBar)
cmdAccent.Size = UDim2.new(1, 0, 0, 1)
cmdAccent.Position = UDim2.new(0, 0, 1, -1)
cmdAccent.BackgroundColor3 = Theme.accent
cmdAccent.BorderSizePixel = 0
cmdAccent.BackgroundTransparency = 0.3

local cmdIcon = Instance.new("Frame", cmdBar)
cmdIcon.Size = UDim2.new(0, 32, 0, 32)
cmdIcon.Position = UDim2.new(0, 9, 0.5, -16)
cmdIcon.BackgroundColor3 = Theme.accent
cmdIcon.BackgroundTransparency = 0.7
corner(cmdIcon, 8)
stroke(cmdIcon, Theme.accent, 1)

local iconText = Instance.new("TextLabel", cmdIcon)
iconText.Size = UDim2.new(1, 0, 1, 0)
iconText.BackgroundTransparency = 1
iconText.Text = ">"
iconText.TextColor3 = Theme.text
iconText.TextSize = 20
iconText.Font = Enum.Font.SourceSansBold

local cmdInputBox = Instance.new("Frame", cmdBar)
cmdInputBox.Size = UDim2.new(1, -140, 0, 32)
cmdInputBox.Position = UDim2.new(0, 50, 0.5, -16)
cmdInputBox.BackgroundColor3 = Theme.secondary
cmdInputBox.BackgroundTransparency = 0.45
corner(cmdInputBox, 8)
stroke(cmdInputBox, Theme.border, 1)

local cmdInput = Instance.new("TextBox", cmdInputBox)
cmdInput.Size = UDim2.new(1, -10, 1, -4)
cmdInput.Position = UDim2.new(0, 5, 0, 2)
cmdInput.BackgroundTransparency = 1
cmdInput.Text = ""
cmdInput.PlaceholderText = "Type command..."
cmdInput.PlaceholderColor3 = Theme.textMuted
cmdInput.TextColor3 = Theme.text
cmdInput.TextSize = 13
cmdInput.Font = Enum.Font.Gotham
cmdInput.TextXAlignment = Enum.TextXAlignment.Left
cmdInput.ClearTextOnFocus = false

local cmdExec = Instance.new("TextButton", cmdBar)
cmdExec.Size = UDim2.new(0, 80, 0, 32)
cmdExec.Position = UDim2.new(1, -90, 0.5, -16)
cmdExec.BackgroundColor3 = Theme.accent
cmdExec.Text = ""
cmdExec.AutoButtonColor = false
corner(cmdExec, 8)

local execGrad = Instance.new("UIGradient", cmdExec)
execGrad.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Theme.accent),
    ColorSequenceKeypoint.new(1, Theme.accentBright)
}
execGrad.Rotation = 135

local execText = Instance.new("TextLabel", cmdExec)
execText.Size = UDim2.new(1, 0, 1, 0)
execText.BackgroundTransparency = 1
execText.Text = "RUN"
execText.TextColor3 = Theme.text
execText.TextSize = 11
execText.Font = Enum.Font.GothamBold

cmdExec.MouseEnter:Connect(function()
    playSound("hover")
    TweenService:Create(cmdExec, TweenInfo.new(0.2), {Size = UDim2.new(0, 85, 0, 34)}):Play()
end)
cmdExec.MouseLeave:Connect(function()
    TweenService:Create(cmdExec, TweenInfo.new(0.2), {Size = UDim2.new(0, 80, 0, 32)}):Play()
end)
cmdExec.MouseButton1Click:Connect(function()
    executeCmd(Config.prefix .. cmdInput.Text, player)
    cmdInput.Text = ""
    TweenService:Create(cmdBar, TweenInfo.new(0.25, Enum.EasingStyle.Quart, Enum.EasingDirection.In), {
        Position = UDim2.new(0.5, -190, 1, 100)
    }):Play()
end)

cmdInput.FocusLost:Connect(function(enter)
    if enter then
        executeCmd(Config.prefix .. cmdInput.Text, player)
        cmdInput.Text = ""
    end
    TweenService:Create(cmdBar, TweenInfo.new(0.25, Enum.EasingStyle.Quart, Enum.EasingDirection.In), {
        Position = UDim2.new(0.5, -190, 1, 100)
    }):Play()
end)

-- Main Frame
local main = Instance.new("Frame", sg)
main.Size = UDim2.new(0, 420, 0, 580)
main.Position = UDim2.new(0.5, -210, 0.5, -290)
main.BackgroundColor3 = Theme.bg
main.BackgroundTransparency = 0.12
main.BorderSizePixel = 0
main.ClipsDescendants = true
corner(main, 14)
stroke(main, Theme.border, 1)

local mainGrad = Instance.new("UIGradient", main)
mainGrad.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Theme.bg),
    ColorSequenceKeypoint.new(0.5, Theme.secondary),
    ColorSequenceKeypoint.new(1, Theme.bg)
}
mainGrad.Rotation = 90

-- Header
local header = Instance.new("Frame", main)
header.Size = UDim2.new(1, 0, 0, 45)
header.BackgroundColor3 = Theme.secondary
header.BackgroundTransparency = 0.25
corner(header, 14)
makeDraggable(main, header)

local title = Instance.new("TextLabel", header)
title.Size = UDim2.new(0, 130, 1, 0)
title.Position = UDim2.new(0, 12, 0, 0)
title.BackgroundTransparency = 1
title.Text = "2TAKE1 ULTRA"
title.TextColor3 = Theme.text
title.TextSize = 15
title.Font = Enum.Font.GothamBold
title.TextXAlignment = Enum.TextXAlignment.Left

local proBadge = Instance.new("TextLabel", header)
proBadge.Size = UDim2.new(0, 45, 0, 20)
proBadge.Position = UDim2.new(0, 145, 0.5, -10)
proBadge.BackgroundColor3 = Theme.gold
proBadge.Text = "PRO"
proBadge.TextColor3 = Color3.fromRGB(0, 0, 0)
proBadge.TextSize = 11
proBadge.Font = Enum.Font.GothamBold
corner(proBadge, 6)

local yearBadge = Instance.new("TextLabel", header)
yearBadge.Size = UDim2.new(0, 42, 0, 16)
yearBadge.Position = UDim2.new(0, 195, 0.5, -8)
yearBadge.BackgroundColor3 = Theme.accent
yearBadge.BackgroundTransparency = 0.15
yearBadge.Text = "2026"
yearBadge.TextColor3 = Theme.text
yearBadge.TextSize = 9
yearBadge.Font = Enum.Font.GothamBold
corner(yearBadge, 5)

-- MINIMIZE BUTTON
local minBtn = Instance.new("TextButton", header)
minBtn.Size = UDim2.new(0, 26, 0, 26)
minBtn.Position = UDim2.new(1, -64, 0.5, -13)
minBtn.BackgroundColor3 = Theme.warning
minBtn.BackgroundTransparency = 0.2
minBtn.Text = "_"
minBtn.TextColor3 = Theme.text
minBtn.TextSize = 18
minBtn.Font = Enum.Font.SourceSansBold
minBtn.AutoButtonColor = false
corner(minBtn, 8)

minBtn.MouseEnter:Connect(function()
    playSound("hover")
    TweenService:Create(minBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.05}):Play()
end)
minBtn.MouseLeave:Connect(function()
    TweenService:Create(minBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.2}):Play()
end)
minBtn.MouseButton1Click:Connect(function()
    playSound("close")
    local isMinimized = main.Size.Y.Offset <= 50
    if isMinimized then
        TweenService:Create(main, TweenInfo.new(0.35, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
            Size = UDim2.new(0, 420, 0, 580),
            Position = UDim2.new(0.5, -210, 0.5, -290)
        }):Play()
    else
        TweenService:Create(main, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
            Size = UDim2.new(0, 420, 0, 45),
            Position = UDim2.new(0.5, -210, 0, 10)
        }):Play()
    end
end)

local closeBtn = Instance.new("TextButton", header)
closeBtn.Size = UDim2.new(0, 26, 0, 26)
closeBtn.Position = UDim2.new(1, -32, 0.5, -13)
closeBtn.BackgroundColor3 = Theme.danger
closeBtn.BackgroundTransparency = 0.2
closeBtn.Text = "X"
closeBtn.TextColor3 = Theme.text
closeBtn.TextSize = 16
closeBtn.Font = Enum.Font.SourceSansBold
closeBtn.AutoButtonColor = false
corner(closeBtn, 8)

closeBtn.MouseEnter:Connect(function()
    playSound("hover")
    TweenService:Create(closeBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.05, Rotation = 90}):Play()
end)
closeBtn.MouseLeave:Connect(function()
    TweenService:Create(closeBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.2, Rotation = 0}):Play()
end)
closeBtn.MouseButton1Click:Connect(function()
    playSound("close")
    TweenService:Create(main, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
        Size = UDim2.new(0, 0, 0, 0),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Rotation = 360
    }):Play()
    TweenService:Create(perf, TweenInfo.new(0.3), {
        Position = UDim2.new(1, 50, 0, 10)
    }):Play()
    task.wait(0.4)
    sg:Destroy()
end)

-- Content
local content = Instance.new("ScrollingFrame", main)
content.Size = UDim2.new(1, -8, 1, -50)
content.Position = UDim2.new(0, 4, 0, 48)
content.BackgroundColor3 = Theme.secondary
content.BackgroundTransparency = 0.7
content.BorderSizePixel = 0
content.ScrollBarThickness = 3
content.ScrollBarImageColor3 = Theme.accent
content.ScrollBarImageTransparency = 0.4
content.AutomaticCanvasSize = Enum.AutomaticSize.Y
corner(content, 12)

local layout = Instance.new("UIListLayout", content)
layout.Padding = UDim.new(0, 6)

-- Stats Frame
local stats = Instance.new("Frame", content)
stats.Size = UDim2.new(1, -4, 0, 200)
stats.BackgroundColor3 = Theme.tertiary
stats.BackgroundTransparency = 0.3
stats.BorderSizePixel = 0
corner(stats, 12)
stroke(stats, Theme.border, 1)

local statsTitle = Instance.new("TextLabel", stats)
statsTitle.Size = UDim2.new(1, -20, 0, 22)
statsTitle.Position = UDim2.new(0, 10, 0, 8)
statsTitle.BackgroundTransparency = 1
statsTitle.Text = "Player Statistics"
statsTitle.TextColor3 = Theme.accent
statsTitle.TextSize = 16
statsTitle.Font = Enum.Font.GothamBold
statsTitle.TextXAlignment = Enum.TextXAlignment.Left

local statLabels = {}
local statData = {
    {name = "power", text = "Power: 0", x = 0, y = 35, w = 0.35},
    {name = "kills", text = "Kills: 0", x = 0.35, y = 35, w = 0.3},
    {name = "health", text = "HP: 100", x = 0.65, y = 35, w = 0.35},
    {name = "fps", text = "FPS: 0", x = 0, y = 58, w = 0.25},
    {name = "ping", text = "Ping: 0ms", x = 0.25, y = 58, w = 0.25},
    {name = "tools", text = "Tools: 0", x = 0.75, y = 58, w = 0.25},
    {name = "pph", text = "P/hr: 0", x = 0, y = 81, w = 0.5},
    {name = "session", text = "Session: +0", x = 0.5, y = 81, w = 0.5},
    {name = "farmTime", text = "Farm: 00:00", x = 0, y = 104, w = 0.5},
    {name = "sessionTime", text = "Time: 00:00", x = 0.5, y = 104, w = 0.5},
    {name = "eff", text = "Status: Idle", x = 0, y = 127, w = 1}
}

for _, s in ipairs(statData) do
    local lbl = Instance.new("TextLabel", stats)
    lbl.Size = UDim2.new(s.w, -6, 0, 20)
    lbl.Position = UDim2.new(s.x, 10, 0, s.y)
    lbl.BackgroundTransparency = 1
    lbl.Text = s.text
    lbl.TextColor3 = Theme.text
    lbl.TextSize = 11
    lbl.Font = Enum.Font.Gotham
    lbl.TextXAlignment = s.x == 0 and Enum.TextXAlignment.Left or (s.x >= 0.5 and Enum.TextXAlignment.Left or Enum.TextXAlignment.Center)
    statLabels[s.name] = lbl
end

-- UI Creation Functions
local uiToggles = {}

local function createToggle(text, callback, config)
    local f = Instance.new("Frame", content)
    f.Size = UDim2.new(1, -4, 0, 45)
    f.BackgroundColor3 = Theme.tertiary
    f.BackgroundTransparency = 0.35
    f.BorderSizePixel = 0
    corner(f, 10)
    stroke(f, Theme.border, 1)
    
    local lbl = Instance.new("TextLabel", f)
    lbl.Size = UDim2.new(1, config and -110 or -65, 1, 0)
    lbl.Position = UDim2.new(0, 12, 0, 0)
    lbl.BackgroundTransparency = 1
    lbl.Text = text
    lbl.TextColor3 = Theme.text
    lbl.TextSize = 11
    lbl.Font = Enum.Font.Gotham
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    
    local input
    if config then
        input = Instance.new("TextBox", f)
        input.Size = UDim2.new(0, 35, 0, 22)
        input.Position = UDim2.new(1, -100, 0.5, -11)
        input.BackgroundColor3 = Theme.secondary
        input.BackgroundTransparency = 0.35
        input.Text = tostring(Config[config.key])
        input.TextColor3 = Theme.text
        input.TextSize = 9
        input.Font = Enum.Font.Gotham
        corner(input, 5)
        
        input.FocusLost:Connect(function()
            local val = tonumber(input.Text)
            if val and val >= (config.min or 1) and val <= (config.max or 100) then
                Config[config.key] = val
                notify(text .. " set to " .. val, 2, "success")
            else
                input.Text = tostring(Config[config.key])
            end
        end)
    end
    
    local btn = Instance.new("TextButton", f)
    btn.Size = UDim2.new(0, 50, 0, 27)
    btn.Position = UDim2.new(1, -58, 0.5, -13.5)
    btn.BackgroundColor3 = Theme.danger
    btn.BackgroundTransparency = 0.2
    btn.Text = "OFF"
    btn.TextColor3 = Theme.text
    btn.TextSize = 9
    btn.Font = Enum.Font.GothamBold
    btn.AutoButtonColor = false
    corner(btn, 6)
    
    local enabled = false
    btn.MouseEnter:Connect(function()
        playSound("hover")
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundTransparency = 0.05}):Play()
    end)
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundTransparency = 0.2}):Play()
    end)
    btn.MouseButton1Click:Connect(function()
        enabled = not enabled
        playSound("click")
        btn.Text = enabled and "ON" or "OFF"
        TweenService:Create(btn, TweenInfo.new(0.2), {
            BackgroundColor3 = enabled and Theme.success or Theme.danger
        }):Play()
        if callback then callback(enabled, btn) end
    end)
    
    uiToggles[text] = btn
    return f, btn, input
end

local function createButton(text, callback, color)
    local btn = Instance.new("TextButton", content)
    btn.Size = UDim2.new(1, -4, 0, 40)
    btn.BackgroundColor3 = color or Theme.tertiary
    btn.BackgroundTransparency = 0.35
    btn.Text = text
    btn.TextColor3 = Theme.text
    btn.TextSize = 11
    btn.Font = Enum.Font.GothamBold
    btn.AutoButtonColor = false
    corner(btn, 10)
    stroke(btn, Theme.border, 1)
    
    btn.MouseEnter:Connect(function()
        playSound("hover")
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundTransparency = 0.2}):Play()
    end)
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundTransparency = 0.35}):Play()
    end)
    btn.MouseButton1Click:Connect(function()
        playSound("click")
        TweenService:Create(btn, TweenInfo.new(0.1), {Size = UDim2.new(1, -6, 0, 38)}):Play()
        task.wait(0.1)
        TweenService:Create(btn, TweenInfo.new(0.15, Enum.EasingStyle.Back), {Size = UDim2.new(1, -4, 0, 40)}):Play()
        if callback then callback() end
    end)
    return btn
end

-- Create UI Elements
createToggle("Fast Farm", function(e) toggleFarm("fast", e) end, {key = "speed", min = 1, max = 10})
createToggle("Slow Farm", function(e) toggleFarm("slow", e) end)
createToggle("God Mode", function(e) setGodMode(e) end)
createToggle("Kill Aura", function(e) toggleKillAura(e) end, {key = "killAuraRange", min = 1, max = 100})
createToggle("Reverse Damage", function(e) State.reverseDmg = e; setupReverseDmg() end)

createButton("Kill All Players", function() executeCmd(";kill all", player) end, Theme.danger)
createButton("God All Players", function() executeCmd(";god all", player) end, Theme.accent)
createButton("Heal All Players", function() executeCmd(";heal all", player) end, Theme.success)
createButton("Reset Session Stats", function()
    Data.stats.farmGain = 0
    Data.stats.sessionStart = tick()
    Data.stats.farmTime = 0
    notify("Stats reset", 3, "success")
end, Theme.info)
createButton("View Commands", function()
    local cmdFrame = sg:FindFirstChild("CommandsFrame")
    if cmdFrame then cmdFrame:Destroy() return end
    
    playSound("open")
    cmdFrame = Instance.new("Frame", sg)
    cmdFrame.Name = "CommandsFrame"
    cmdFrame.Size = UDim2.new(0, 380, 0, 480)
    cmdFrame.Position = UDim2.new(0.5, -190, 0.5, -240)
    cmdFrame.BackgroundColor3 = Theme.bg
    cmdFrame.BackgroundTransparency = 0.12
    cmdFrame.ClipsDescendants = true
    corner(cmdFrame, 14)
    stroke(cmdFrame, Theme.border, 1)
    makeDraggable(cmdFrame)
    
    local cmdHeader = Instance.new("Frame", cmdFrame)
    cmdHeader.Size = UDim2.new(1, 0, 0, 40)
    cmdHeader.BackgroundColor3 = Theme.secondary
    cmdHeader.BackgroundTransparency = 0.25
    corner(cmdHeader, 14)
    
    local cmdTitle = Instance.new("TextLabel", cmdHeader)
    cmdTitle.Size = UDim2.new(1, -40, 1, 0)
    cmdTitle.Position = UDim2.new(0, 12, 0, 0)
    cmdTitle.BackgroundTransparency = 1
    cmdTitle.Text = "Command List"
    cmdTitle.TextColor3 = Theme.text
    cmdTitle.TextSize = 15
    cmdTitle.Font = Enum.Font.GothamBold
    cmdTitle.TextXAlignment = Enum.TextXAlignment.Left
    
    local cmdClose = Instance.new("TextButton", cmdHeader)
    cmdClose.Size = UDim2.new(0, 30, 0, 30)
    cmdClose.Position = UDim2.new(1, -35, 0.5, -15)
    cmdClose.BackgroundColor3 = Theme.danger
    cmdClose.BackgroundTransparency = 0.15
    cmdClose.Text = "X"
    cmdClose.TextColor3 = Theme.text
    cmdClose.TextSize = 15
    cmdClose.Font = Enum.Font.SourceSansBold
    cmdClose.AutoButtonColor = false
    corner(cmdClose, 8)
    
    cmdClose.MouseButton1Click:Connect(function()
        playSound("close")
        TweenService:Create(cmdFrame, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
            Size = UDim2.new(0, 0, 0, 0),
            Position = UDim2.new(0.5, 0, 0.5, 0),
            Rotation = 180
        }):Play()
        task.wait(0.3)
        cmdFrame:Destroy()
    end)
    
    local cmdScroll = Instance.new("ScrollingFrame", cmdFrame)
    cmdScroll.Size = UDim2.new(1, -8, 1, -48)
    cmdScroll.Position = UDim2.new(0, 4, 0, 44)
    cmdScroll.BackgroundColor3 = Theme.secondary
    cmdScroll.BackgroundTransparency = 0.65
    cmdScroll.BorderSizePixel = 0
    cmdScroll.ScrollBarThickness = 3
    cmdScroll.ScrollBarImageColor3 = Theme.accent
    cmdScroll.ScrollBarImageTransparency = 0.4
    cmdScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
    corner(cmdScroll, 12)
    
    local cmdLayout = Instance.new("UIListLayout", cmdScroll)
    cmdLayout.Padding = UDim.new(0, 5)
    
    for _, cmd in ipairs(cmds) do
        local item = Instance.new("Frame", cmdScroll)
        item.Size = UDim2.new(1, 0, 0, 50)
        item.BackgroundColor3 = Theme.tertiary
        item.BackgroundTransparency = 0.35
        item.BorderSizePixel = 0
        corner(item, 10)
        stroke(item, Theme.border, 1)
        
        local name = Instance.new("TextLabel", item)
        name.Size = UDim2.new(1, -16, 0, 22)
        name.Position = UDim2.new(0, 8, 0, 3)
        name.BackgroundTransparency = 1
        name.Text = Config.prefix .. cmd[1]
        name.TextColor3 = Theme.accent
        name.TextSize = 12
        name.Font = Enum.Font.GothamBold
        name.TextXAlignment = Enum.TextXAlignment.Left
        
        local desc = Instance.new("TextLabel", item)
        desc.Size = UDim2.new(1, -16, 0, 20)
        desc.Position = UDim2.new(0, 8, 0, 25)
        desc.BackgroundTransparency = 1
        desc.Text = cmd[2]
        desc.TextColor3 = Theme.textDim
        desc.TextSize = 10
        desc.Font = Enum.Font.Gotham
        desc.TextXAlignment = Enum.TextXAlignment.Left
    end
end, Theme.accent)

-- Update Loop
local lastUpdate = 0
RunService.Heartbeat:Connect(function(dt)
    local currentFps = math.floor(1 / dt)
    fpsLabel.Text = "FPS: " .. currentFps
    fpsLabel.TextColor3 = currentFps >= 55 and Theme.success or currentFps >= 28 and Theme.warning or Theme.danger
    
    local ping = math.floor(player:GetNetworkPing() * 1000)
    pingLabel.Text = "Ping: " .. ping .. "ms"
    pingLabel.TextColor3 = ping <= 80 and Theme.success or ping <= 150 and Theme.warning or Theme.danger
    
    local mem = math.floor(Stats:GetTotalMemoryUsageMb())
    memLabel.Text = "Memory: " .. mem .. "MB"
    
    local t = tick()
    if t - lastUpdate < 0.05 then return end
    lastUpdate = t
    
    local target = State.watching or player
    local ls = target:FindFirstChild("leaderstats")
    
    if ls then
        local powerStat = ls:FindFirstChild("Power") or ls:FindFirstChild("power")
        local killsStat = ls:FindFirstChild("Kills") or ls:FindFirstChild("kills")
        
        if powerStat then Data.stats.power = tonumber(powerStat.Value) or 0 end
        if killsStat then Data.stats.kills = tonumber(killsStat.Value) or 0 end
    end
    
    local hum = target.Character and target.Character:FindFirstChildOfClass("Humanoid")
    if hum then
        Data.stats.health = math.floor(hum.Health)
    end
    
    local toolCount = updateToolCache()
    
    statLabels.power.Text = "Power: " .. formatNum(Data.stats.power)
    statLabels.kills.Text = "Kills: " .. formatNum(Data.stats.kills)
    statLabels.health.Text = State.godMode and "HP: ‚àû" or ("HP: " .. Data.stats.health)
    statLabels.fps.Text = "FPS: " .. currentFps
    statLabels.ping.Text = "Ping: " .. ping .. "ms"
    statLabels.tools.Text = "Tools: " .. toolCount
    statLabels.tools.TextColor3 = toolCount > 0 and Theme.success or Theme.danger
    
    if State.fastFarm or State.slowFarm then
        Data.stats.farmTime = Data.stats.farmTime + dt
        Data.stats.farmGain = Data.stats.power - Data.stats.farmStart
        Data.stats.powerPerHour = (Data.stats.farmGain / Data.stats.farmTime) * 3600
        
        statLabels.pph.Text = "P/hr: " .. formatNum(Data.stats.powerPerHour)
        statLabels.session.Text = "Session: +" .. formatNum(Data.stats.farmGain)
        statLabels.farmTime.Text = "Farm: " .. formatTime(Data.stats.farmTime)
        statLabels.eff.Text = "Status: Farming Active"
        statLabels.eff.TextColor3 = Theme.success
    else
        statLabels.pph.Text = "P/hr: 0"
        statLabels.session.Text = "Session: +" .. formatNum(Data.stats.farmGain)
        statLabels.farmTime.Text = "Farm: " .. formatTime(Data.stats.farmTime)
        statLabels.eff.Text = "Status: Idle"
        statLabels.eff.TextColor3 = Theme.warning
    end
    
    local sessionTime = t - Data.stats.sessionStart
    statLabels.sessionTime.Text = "Time: " .. formatTime(sessionTime)
    
    if State.watching then
        statsTitle.Text = "Watching: " .. State.watching.DisplayName
        statsTitle.TextColor3 = Theme.warning
    else
        statsTitle.Text = "Player Statistics"
        statsTitle.TextColor3 = Theme.accent
    end
end)

-- Character Management
local function onCharacter(char)
    if not char then return end
    updateToolCache()
    
    local hum = char:WaitForChild("Humanoid", 5)
    if hum then
        hum.WalkSpeed = State.speedHack and Config.flySpeed or Config.walkSpeed
        hum.JumpPower = Config.jumpPower
        
        if State.reverseDmg then
            task.wait(0.5)
            setupReverseDmg()
        end
        if State.godMode then
            task.wait(0.5)
            setGodMode(true)
        end
        if State.noclip then
            toggleNoclip()
            toggleNoclip()
        end
        if State.speedHack then
            setSpeed(Config.flySpeed)
        end
    end
end

if player.Character then onCharacter(player.Character) end
player.CharacterAdded:Connect(onCharacter)

-- Whitelist Check
for _, id in ipairs(Config.whitelist) do
    for _, p in ipairs(Players:GetPlayers()) do
        if p.UserId == id and not table.find(Data.admins, p.Name) then
            table.insert(Data.admins, p.Name)
        end
    end
end
table.insert(Data.admins, player.Name)

Players.PlayerAdded:Connect(function(p)
    for _, id in ipairs(Config.whitelist) do
        if p.UserId == id and not table.find(Data.admins, p.Name) then
            table.insert(Data.admins, p.Name)
        end
    end
end)

-- Chat Commands
player.Chatted:Connect(function(msg)
    if msg:sub(1, 1) == Config.prefix then
        executeCmd(msg, player)
    end
end)

-- Keybinds
UIS.InputBegan:Connect(function(input, gp)
    if gp then return end
    
    if input.KeyCode == Enum.KeyCode.Semicolon and not cmdInput:IsFocused() then
        playSound("open")
        cmdBar.Visible = true
        TweenService:Create(cmdBar, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
            Position = UDim2.new(0.5, -190, 1, -65)
        }):Play()
        task.wait(0.15)
        cmdInput:CaptureFocus()
    elseif input.KeyCode == Enum.KeyCode.Escape and cmdInput:IsFocused() then
        cmdInput:ReleaseFocus()
        TweenService:Create(cmdBar, TweenInfo.new(0.25, Enum.EasingStyle.Quart, Enum.EasingDirection.In), {
            Position = UDim2.new(0.5, -190, 1, 100)
        }):Play()
    elseif input.KeyCode == Enum.KeyCode.Insert then
        main.Visible = not main.Visible
        playSound(main.Visible and "open" or "close")
    end
end)

-- IMPROVED Startup Animation
task.spawn(function()
    main.Size = UDim2.new(0, 0, 0, 0)
    main.Position = UDim2.new(0.5, 0, 0.5, 0)
    main.Rotation = -180
    perf.Position = UDim2.new(1, 50, 0, 10)
    
    TweenService:Create(main, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
        Size = UDim2.new(0, 420, 0, 580),
        Position = UDim2.new(0.5, -210, 0.5, -290),
        Rotation = 0
    }):Play()
    TweenService:Create(perf, TweenInfo.new(0.55, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
        Position = UDim2.new(1, -170, 0, 10)
    }):Play()
    
    notify("‚ú® 2TAKE1 ULTRA PRO 2026 Loaded!", 3, "success")
    task.wait(2)
    notify("üéÆ Press ; for commands | INSERT to toggle UI", 3, "info")
end)
